#Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ±ĞµĞ· Docker. ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ±ĞµĞ·? ĞŸĞ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾ Ğ² GitVerse Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ docker.sock -> ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑÑ‚ÑÑ Ğ² Ğ¾Ğ±Ğ»Ğ°ĞºĞµ.

name: energotechnics tests

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Chrome
        run: |
          sudo apt-get update && sudo apt-get install -y wget
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
          rm google-chrome-stable_current_amd64.deb

      - name: Install Node.js
        run: |
          sudo apt-get update && sudo apt-get install -y curl
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo bash -
          sudo apt-get install -y nodejs

      - name: Install Allure
        run: |
          npm install -g allure-commandline
          npm install -g allure

      - name: Install Maven
        run: |
          sudo apt-get update
          sudo apt-get install -y maven

      - name: Run tests
        run: |
          export CHROME_BIN=/usr/bin/google-chrome-stable
          mvn test -Dheadless=true -Dmaven.test.failure.ignore=true

      - name: Upload Allure results
        uses: actions/upload-pages-artifact@v1
        if: always()
        with:
          name: allure-results
          path: allure-results/

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '>=1.23'

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Generate Allure report
        run: |
          allure generate allure-results -o allure-report
        if: always()

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v1
        if: always()
        with:
          path: allure-report
          name: gitverse-pages

      - name: Deploy to GitVerse Pages
        id: deployment
        uses: actions/deploy-pages@v1
        with:
          artifact_name: gitverse-pages
          token: ${{ secrets.GITVERSE_TOKEN }}

      - name: Print deploy URL
        run: echo "ğŸŒ page_url = ${{ steps.deployment.outputs.page_url }}"